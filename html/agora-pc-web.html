<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>电脑 ↔ 手机 音视频通话</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      width: 100vw; height: 100vh; background: #000; color: #fff;
      font-family: "Microsoft YaHei"; overflow: hidden;
    }
    #remote-video { 
      width: 40%; height: 100%; object-fit: cover;
      position: absolute; left:30%; top:0; z-index:1;
    }
    #local-video { 
      width: 300px; height: 225px; object-fit: contain;
      position: absolute; right:20px; top:20px; z-index:2;
      border: 2px solid #fff; border-radius:8px;
      background: #333;
    }
    #hangup-btn {
      width:70px; height:70px; border-radius:50%;
      background:#dc2626; color:#fff; border:none;
      position:absolute; left:50%; bottom:30px; transform:translateX(-50%);
      z-index:3; cursor:pointer;
    }
    #audio-btn {
      width:120px; height:40px; background:#2196F3; color:#fff; border:none;
      position:absolute; left:20px; bottom:30px; z-index:3; cursor:pointer;
      border-radius:4px; display:none; /* 默认隐藏 */
    }
    #auth-btn {
      width:150px; height:50px; background:#4CAF50; color:#fff; border:none;
      position:absolute; left:50%; top:50%; transform:translate(-50%, -50%);
      z-index:10; cursor:pointer;
      border-radius:8px; font-size:16px;
    }
    #status {
      position:absolute; left:20px; top:20px; z-index:2;
      background:rgba(0,0,0,0.5); padding:8px 12px; border-radius:4px;
      max-width: 80%;
    }
    .warning {
      color: #ff9800;
      font-weight: bold;
    }
    .error {
      color: #f44336;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div id="status">初始化中...</div>
  <video id="remote-video" autoplay playsinline></video>
  <video id="local-video" autoplay playsinline muted></video>
  <button id="hangup-btn">挂断</button>
  <button id="audio-btn">点击开启声音</button>
  <!-- 新增：主动授权按钮 -->
  <button id="auth-btn">点击授权音视频权限</button>

<script src="https://cdn.agora.io/sdk/release/AgoraRTC_N.js"></script>
<script>
const APP_ID = "585ceb26ea044e649a7a39304d323dc7";
const CHANNEL_NAME = "HoneyFamily";
const LOCAL_UID = 1003;

let client;
let localAudioTrack, localVideoTrack;
let remoteAudioTrack = null;
const statusDom = document.getElementById('status');
const remoteVideo = document.getElementById('remote-video');
const localVideo = document.getElementById('local-video');
const hangupBtn = document.getElementById('hangup-btn');
const audioBtn = document.getElementById('audio-btn');
const authBtn = document.getElementById('auth-btn');

// 协议检测
function checkSecureContext() {
  if (!window.isSecureContext) {
    statusDom.innerHTML = '<span class="warning">警告：非安全连接！</span><br>浏览器禁止在HTTP协议下使用摄像头/麦克风，请：<br>1. 使用HTTPS访问<br>2. 或在localhost/127.0.0.1下测试';
    authBtn.style.display = "none";
    return false;
  }
  return true;
}

// 主动请求音视频权限
async function requestMediaPermissions() {
  try {
    authBtn.style.display = "none";
    statusDom.innerText = "正在请求音视频权限...";
    
    // 显式请求权限（关键：必须由用户点击触发）
    const stream = await navigator.mediaDevices.getUserMedia({
      audio: true,
      video: true
    });
    
    // 释放临时流（仅用于获取权限）
    stream.getTracks().forEach(track => track.stop());
    
    statusDom.innerText = "音视频权限已获取！";
    setTimeout(() => startCall(), 1000);
  } catch (error) {
    let errorMsg = "";
    if (error.name === "NotAllowedError") {
      errorMsg = "权限被拒绝！请在浏览器地址栏左侧的摄像头图标中，允许本网站使用摄像头和麦克风";
    } else if (error.name === "NotFoundError") {
      errorMsg = "未检测到摄像头/麦克风设备！请检查设备是否连接且未被占用";
    } else {
      errorMsg = `权限请求失败：${error.message}`;
    }
    statusDom.innerHTML = `<span class="error">${errorMsg}</span>`;
    console.error("权限请求错误：", error);
    authBtn.style.display = "block"; // 重新显示授权按钮
  }
}

// 动态获取Token
async function getTokenFromServer() {
  try {
    statusDom.innerText = "正在获取Token...";
    const response = await fetch('https://of1wd11788567.vicp.fun/heima/token/getToken', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        "uid": LOCAL_UID
      })
    });    
    if (!response.ok) {
      throw new Error(`HTTP错误，状态码：${response.status}`);
    }

    const token = await response.text();
    const cleanToken = token.trim();
    
    if (!cleanToken) {
      throw new Error("接口返回的Token为空");
    }

    statusDom.innerText = "Token获取成功";
    return cleanToken;
  } catch (error) {
    statusDom.innerText = "获取Token失败：" + error.message;
    console.error("获取Token出错：", error);
    throw error;
  }
}

// 订阅远端用户
async function subscribeAndPlay(user) {
  try {
    await client.subscribe(user, "audio");
    await client.subscribe(user, "video");
    statusDom.innerText = `已连接手机（UID:${user.uid}），画面已显示`;

    if (user.videoTrack) {
      user.videoTrack.play(remoteVideo, { fit: "fill" });
    }

    if (user.audioTrack) {
      remoteAudioTrack = user.audioTrack;
      tryPlayAudio();
    }
  } catch (e) {
    console.error("订阅失败", e);
    statusDom.innerText = "订阅失败：" + e.message;
  }
}

// 尝试播放音频
function tryPlayAudio() {
  if (!remoteAudioTrack) return;
  
  try {
    remoteAudioTrack.play();
    statusDom.innerText += "，声音正常";
  } catch (e) {
    statusDom.innerText += "，请点击「开启声音」按钮";
    audioBtn.style.display = "block";
  }
}

// 点击开启音频
audioBtn.onclick = () => {
  if (remoteAudioTrack) {
    remoteAudioTrack.play();
    audioBtn.style.display = "none";
    statusDom.innerText = "已连接手机，声音+画面正常";
  }
};

async function startCall() {
  try {
    // 检测安全上下文（非安全上下文不执行后续逻辑）
    if (!checkSecureContext()) return;

    // 获取Token
    const TOKEN = await getTokenFromServer();

    // 初始化客户端
    client = AgoraRTC.createClient({ mode: "rtc", codec: "h264" });

    // 监听自动播放失败
    AgoraRTC.onAutoplayFailed = () => {
      statusDom.innerText = "需要点击页面开启声音";
      audioBtn.style.display = "block";
    };

    // 监听新用户上线
    client.on("user-published", async (user) => {
      await subscribeAndPlay(user);
    });

    client.on("user-left", (user) => {
      statusDom.innerText = "手机已离开";
      remoteVideo.srcObject = null;
      remoteAudioTrack = null;
      audioBtn.style.display = "none";
    });

    // 加入频道
    await client.join(APP_ID, CHANNEL_NAME, TOKEN, LOCAL_UID);
    statusDom.innerText = "已加入频道，查找在线用户...";

    // 连接已在线用户
    const remoteUsers = client.remoteUsers;
    if (remoteUsers.length > 0) {
      statusDom.innerText = `发现 ${remoteUsers.length} 台手机在线，正在连接...`;
      for (const u of remoteUsers) {
        await subscribeAndPlay(u);
      }
    }

    // 关键修改：显式创建本地音视频轨道（带错误提示）
    statusDom.innerText = "正在初始化本地音视频设备...";
    try {
      // 创建麦克风轨道
      localAudioTrack = await AgoraRTC.createMicrophoneAudioTrack({
        encoderConfig: {
          sampleRate: 48000,
          channelNum: 1,
          bitrate: 48000
        }
      });
      
      // 创建摄像头轨道
      localVideoTrack = await AgoraRTC.createCameraVideoTrack({
        encoderConfig: {
          width: 640,
          height: 480,
          frameRate: 15,
          bitrate: 500000
        }
      });
      
      // 播放本地视频（确保显示）
      localVideoTrack.play(localVideo);
      statusDom.innerText = "本地音视频设备初始化成功！";

      // 发布本地轨道
      await client.publish([localAudioTrack, localVideoTrack]);
      statusDom.innerText += " 已发布本地音视频流";

    } catch (e) {
      statusDom.innerHTML = `<span class="error">本地设备初始化失败：${e.message}</span><br>请检查：1. 设备是否被占用 2. 权限是否开启`;
      console.error("本地音视频创建失败：", e);
      // 即使本地设备失败，仍能接收远端流
    }

  } catch (e) {
    statusDom.innerText = "错误：" + e.message;
    console.error(e);
  }
}

// 挂断通话
async function hangup() {
  try {
    // 关闭本地轨道
    if (localAudioTrack) {
      localAudioTrack.close();
      localAudioTrack = null;
    }
    if (localVideoTrack) {
      localVideoTrack.close();
      localVideoTrack = null;
      localVideo.srcObject = null; // 清空视频画面
    }
    
    remoteAudioTrack = null;
    // 离开频道
    if (client) {
      await client.leave();
      client = null;
    }
    
    statusDom.innerText = "已挂断";
    audioBtn.style.display = "none";
    authBtn.style.display = "block"; // 重新显示授权按钮
  } catch (e) {
    console.error("挂断失败：", e);
  }
}

// 页面加载完成初始化
window.onload = () => {
  // 检测安全上下文
  checkSecureContext();
  
  // 绑定按钮事件
  authBtn.onclick = requestMediaPermissions;
  hangupBtn.onclick = hangup;
  audioBtn.onclick = () => {
    if (remoteAudioTrack) {
      remoteAudioTrack.play();
      audioBtn.style.display = "none";
      statusDom.innerText = "已开启远端声音";
    }
  };
};

// 页面关闭前挂断
window.onbeforeunload = hangup;

</script>
</body>
</html>